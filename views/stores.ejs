<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Stores</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="icon" href="/images/storage.png" sizes="32x32">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    .table thead th { vertical-align: middle; }
  </style>
</head>
<body>

<!-- ‚úÖ Form ‡πÅ‡∏¢‡∏Å‡∏ô‡∏≠‡∏Å modal (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏•‡∏ö) -->
<form method="POST" id="deleteForm"></form>

<!-- ‚úÖ Modal: Confirm Delete -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="deleteModalAlert"></div>
        <p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤: <strong id="storeToDelete">---</strong> ?</p>
        <div class="small text-muted">‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö Transaction ‡πÄ‡∏î‡∏¥‡∏°</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞ submit ‡∏ü‡∏≠‡∏£‡πå‡∏° deleteForm (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡∏¢‡∏¥‡∏á DELETE) -->
        <button type="submit" class="btn btn-danger" form="deleteForm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Modal: Add/Edit Store -->
<div class="modal fade" id="storeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="storeModalLabel">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="storeModalAlert"></div>
        <form id="storeForm" autocomplete="off">
          <input type="hidden" id="_id">
          <div class="mb-3">
            <label class="form-label fw-bold" for="storeId">Store ID</label>
            <input type="number" min="0" step="1" id="storeId" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô 17" required>
            <div class="form-text">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° (0 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥</div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold" for="storename">Store Name</label>
            <input type="text" id="storename" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô Thonglor" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
        <button class="btn btn-primary" id="btnSave" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="desktop-sidebar col-lg-2 col-12 d-none d-lg-block">
      <%- include('sidebar') %>
    </div>
    <%- include('sidebarMobile') %>

    <div class="col-lg-10 col-12">
      <h2 class="text-center p-4">
        Manage Stores
        <img src="/images/edit.png" alt="logo" class="img-fluid" style="max-width:40px; vertical-align:middle" />
      </h2>

      <!-- Actions + Search -->
      <div class="container-fluid">
        <div class="p-3">
          <div class="row gy-2 align-items-center">
            <div class="col-lg-6 col-12 mx-auto">
              <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ parts: ‡∏à‡∏∞ filter ‡πÉ‡∏ô client-side -->
              <form class="d-flex" onsubmit="event.preventDefault();">
                <input type="text" id="searchInput" class="form-control me-2" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Store ID ‡∏´‡∏£‡∏∑‡∏≠ Store Name">
                <button type="button" id="btnSearch" class="btn btn-success">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
              </form>
            </div>
            <div class="col-lg-6 col-12 text-lg-end text-center">
              <button class="btn btn-primary" id="btnAddStore">
                <i class="bi bi-plus-lg"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="alertWrap" class="px-3"></div>

      <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
      <div class="table-responsive px-3">
        <table class="table table-striped table-bordered table-hover">
          <thead>
            <tr class="table-dark">
              <th class="text-center col-2">Store ID</th>
              <th class="text-center col-7">Store Name</th>
              <th class="text-center col-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
              <th class="text-center col-1">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody id="storeTbody">
            <!-- rows fill by JS -->
          </tbody>
        </table>
        <div id="noResult" class="alert alert-warning text-center d-none">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // -------- State / Helper ----------
  let cache = [];        // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å /stores/list
  let keyword = '';      // ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤

  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  function showAlertIn(containerSel, type, text, timeout = 2500) {
  const wrap = document.querySelector(containerSel);
  if (!wrap) return;
  wrap.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
      ${text}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;
  if (timeout) setTimeout(() => { if (wrap) wrap.innerHTML = ''; }, timeout);
}


  function showAlert(type, text, timeout = 2500) {
    const wrap = $('#alertWrap');
    wrap.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${text}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    if (timeout) setTimeout(() => wrap.innerHTML = '', timeout);
  }

  async function fetchJSON(url, options = {}) {
    const res = await fetch(url, {
      headers: { 'Content-Type': 'application/json' },
      ...options
    });
    let data = {};
    try { data = await res.json(); } catch(e) {}
    if (!res.ok || data.ok === false) {
      const msg = data.message || data.error || res.statusText || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
      throw new Error(msg);
    }
    return data;
  }

  function renderRows(items) {
    const tbody = $('#storeTbody');
    tbody.innerHTML = '';

    if (!items || items.length === 0) {
      $('#noResult').classList.remove('d-none');
      return;
    }
    $('#noResult').classList.add('d-none');

    items.forEach(item => {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td class="text-center">${String(item.storeId ?? '').padStart(3, '0')}</td>
        <td class="text-start">${escapeHtml(item.storename || '')}</td>
        <td class="text-center">
          <button class="btn btn-warning btn-sm btn-edit" data-id="${item._id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </td>
        <td class="text-center">
          <button class="btn btn-danger btn-sm btn-del"
                  data-id="${item._id}"
                  data-label="${String(item.storeId ?? '').padStart(3,'0')} - ${escapeHtml(item.storename || '')}">
            ‡∏•‡∏ö
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function applyFilter() {
  const kw = (keyword || '').trim().toLowerCase();
  if (!kw) { renderRows(cache); return; }

  const isDigitsOnly = /^\d+$/.test(kw);      // ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡πâ‡∏ß‡∏ô‡πÑ‡∏´‡∏°
  const kwNoZero = kw.replace(/^0+/, '') || '0'; // "004" -> "4", ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡∏°‡∏û‡πå "000" ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "0"
  const paddedKw = kw.padStart(3, '0');       // "4"   -> "004", "09" -> "009"

  const filtered = cache.filter(x => {
    const raw = String(x.storeId ?? '');           // ‡πÄ‡∏ä‡πà‡∏ô "4"
    const padded = raw.padStart(3, '0');           // ‡πÄ‡∏ä‡πà‡∏ô "004"
    const nameStr = String(x.storename ?? '').toLowerCase();

    if (isDigitsOnly) {
      // ‚úÖ ‡πÄ‡∏•‡∏Ç‡∏•‡πâ‡∏ß‡∏ô: match ‡πÅ‡∏ö‡∏ö "‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      // - ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "004" ‚Üí ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö storeId 4 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      // - ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "4"   ‚Üí ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö storeId 4 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      return padded === paddedKw || raw === kwNoZero;
    } else {
      // üîé ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö contains
      return nameStr.includes(kw);
    }
  });

  renderRows(filtered);
}



  // -------- Modal helpers ----------
  const storeModalEl = document.getElementById('storeModal');
  const storeModal = new bootstrap.Modal(storeModalEl);
  const deleteModalEl = document.getElementById('deleteModal');
  const deleteModal = new bootstrap.Modal(deleteModalEl);

  function setForm(data = {}) {
    document.getElementById('_id').value = data._id || '';
    document.getElementById('storeId').value = data.storeId ?? '';
    document.getElementById('storename').value = data.storename ?? '';
  }

  function getForm() {
    return {
      id: document.getElementById('_id').value,
      storeId: document.getElementById('storeId').value,
      storename: document.getElementById('storename').value.trim()
    };
  }

  // -------- Init ----------
  document.addEventListener('DOMContentLoaded', async () => {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    try {
      const json = await fetchJSON('/stores/list');
      cache = json.data || [];
      renderRows(cache);
    } catch (err) {
      showAlert('danger', err.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    $('#btnSearch').addEventListener('click', () => {
      keyword = $('#searchInput').value || '';
      applyFilter();
    });
    $('#searchInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); $('#btnSearch').click(); }
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°
    $('#btnAddStore').addEventListener('click', () => {
      setForm({});
      document.getElementById('storeModalLabel').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤';
      showAlertIn('#storeModalAlert', 'info', '', 1);
      storeModal.show();
    });

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (event delegation)
    document.getElementById('storeTbody').addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-edit');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const found = cache.find(x => x._id === id);
      if (!found) return showAlert('danger', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
      setForm(found);
      document.getElementById('storeModalLabel').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤';
      showAlertIn('#storeModalAlert', 'info', '', 1);
      storeModal.show();
    });

    // ‡∏•‡∏ö (‡πÄ‡∏õ‡∏¥‡∏î modal)
    document.getElementById('storeTbody').addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-del');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const label = btn.getAttribute('data-label') || '---';

      // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á action ‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
      document.getElementById('storeToDelete').textContent = label;
      const form = document.getElementById('deleteForm');
      form.setAttribute('data-id', id); // ‡πÄ‡∏Å‡πá‡∏ö id ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô submit

      showAlertIn('#deleteModalAlert', 'info', '', 1);

      deleteModal.show();
    });

    // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö ‚Üí intercept form submit ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏¥‡∏á DELETE
    document.getElementById('deleteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = e.target.getAttribute('data-id');
      if (!id) return;
      try {
        await fetchJSON(`/stores/${id}`, { method: 'DELETE' });
        showAlert('success', '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        deleteModal.hide();
        // refresh cache
        const j = await fetchJSON('/stores/list');
        cache = j.data || [];
        applyFilter();
      } catch (err) {
        showAlertIn('#deleteModalAlert', 'danger', err.message || '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    });

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
    document.getElementById('btnSave').addEventListener('click', async () => {
  const { id, storeId, storename } = getForm();

  // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏±‡∏•‡∏Ç‡∏ì‡∏∞ validate
  if (storeId === '' || isNaN(Number(storeId)) || Number(storeId) < 0) {
    return showAlertIn('#storeModalAlert', 'warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Store ID ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° (0 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)');
  }
  if (!storename) {
    return showAlertIn('#storeModalAlert', 'warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Store Name');
  }

  try {
    if (id) {
      await fetchJSON(`/stores/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ storeId, storename })
      });
      // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏• ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏ä‡∏ß‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á
      storeModal.hide();
      const j = await fetchJSON('/stores/list');
      cache = j.data || [];
      applyFilter();
      showAlert('success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } else {
      await fetchJSON('/stores', {
        method: 'POST',
        body: JSON.stringify({ storeId, storename })
      });
      storeModal.hide();
      const j = await fetchJSON('/stores/list');
      cache = j.data || [];
      applyFilter();
      showAlert('success', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  } catch (err) {
    showAlertIn('#storeModalAlert', 'danger', err.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
});


  });
</script>
</body>
</html>
