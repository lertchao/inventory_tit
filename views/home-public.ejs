<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Announcement</title>

  <!-- Bootstrap / Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- Project styles / favicon -->
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="icon" href="/images/storage.png" sizes="32x32">
</head>
<body>
  <%
  // ===== Date helpers (Bangkok) =====
  const fmtDateTimeGB = (d) => {
    try {
      if (!d) return '';
      return new Date(d).toLocaleString('en-GB', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit',
        hour12: false, timeZone: 'Asia/Bangkok'
      });
    } catch { return ''; }
  };
  const isoDateTime = (d) => {
    try { return new Date(d).toISOString(); } catch { return ''; }
  };
%>


<div class="container-fluid">
  <div class="row">
    <!-- Sidebar desktop -->
    <div class="desktop-sidebar col-lg-2 col-12 d-none d-lg-block">
      <%- include('sidebar-public') %>
    </div>
    <!-- Sidebar mobile -->
    <%- include('sidebarMobile-public') %>

    <div class="col-lg-10 col-12">
      <!-- Header -->
      <header class="d-flex align-items-center justify-content-between py-4">
        <h2 class="m-0">
          Announcement
          <img src="/images/megaphone.png" alt="logo" class="img-fluid align-middle" style="max-width:40px"/>
        </h2>

        <% if (isAdmin) { %>
          <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" data-bs-toggle="offcanvas" data-bs-target="#newPostCanvas">
              <i class="bi bi-plus-lg me-1"></i> New
            </button>
          </div>
        <% } %>
      </header>

      <!-- Toolbar -->
      <div class="sticky-top bg-white p-3 mb-3 border rounded-3 shadow-sm">
        <form class="row g-2 align-items-center" method="get" action="/public-home">
          <div class="col-md-4">
            <input type="search" name="q" value="<%= q || '' %>" class="form-control" placeholder="ค้นหาหัวข้อหรือคำสำคัญ…"/>
          </div>
          <div class="col-md-6 d-flex gap-2 flex-wrap">
            <% const cat = (category || '').toString(); %>
            <a href="/public-home" class="btn btn-sm <%= cat ? 'btn-outline-secondary' : 'btn-secondary' %>">All</a>
            <a href="/public-home?category=general" class="btn btn-sm <%= cat==='general'?'btn-secondary':'btn-outline-secondary' %>">General</a>
            <a href="/public-home?category=policy" class="btn btn-sm <%= cat==='policy'?'btn-success':'btn-outline-secondary' %>">Policy</a>
            <a href="/public-home?category=urgent" class="btn btn-sm <%= cat==='urgent'?'btn-danger':'btn-outline-secondary' %>">Urgent</a>
          </div>
          <div class="col-md-2 text-md-end">
            <button class="btn btn-outline-primary btn-sm w-100">
              <i class="bi bi-search me-1"></i> Search
            </button>
          </div>
        </form>
      </div>

      <!-- Featured -->
      <% if (featured) { %>
        <section class="card border rounded-4 overflow-hidden shadow-sm mb-4">
          <% if (featured.imageUrl) { %>
            <div class="ratio ratio-21x9">
              <img src="<%= featured.imageUrl %>" class="w-100 h-100 object-fit-cover" alt="featured">
            </div>
          <% } %>
          <div class="card-body p-4">
            <div class="d-flex align-items-center gap-2 mb-2">
              <% const isCatUrgentFeatured = (featured.category === 'urgent'); %>
              <% if (featured.isPinned) { %><span class="badge text-bg-warning">Pinned</span><% } %>
              <% if (isCatUrgentFeatured) { %>
                <span class="badge text-bg-danger">Urgent</span>
              <% } %>
              <% if (featured.category && featured.category !== 'urgent') { %>
                <span class="badge text-bg-secondary text-capitalize"><%= featured.category %></span>
              <% } %>
            </div>

            <h3 class="mb-2"><%= featured.title %></h3>
            <p class="text-muted mb-3"><%= featured.excerpt || '' %></p>

            <div class="small text-muted">
              <i class="bi bi-person-circle me-1"></i>
              <%= featured.author || '—' %>
                <span class="mx-2">·</span>
                <i class="bi bi-clock me-1"></i>
                <time datetime="<%= isoDateTime(featured.publishedAt) %>" data-order="<%= isoDateTime(featured.publishedAt) %>">
                  <%= fmtDateTimeGB(featured.publishedAt) %>
                </time>
            
            </div>

            <div class="mt-3 d-flex gap-2">
              <a href="/public-announcement/<%= featured._id %>" class="btn btn-sm btn-outline-primary">Read more</a>
              <% if (isAdmin) { %>
                <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="<%= featured._id %>">
                  <i class="bi bi-trash me-1"></i> Delete
                </button>
              <% } %>
            </div>
          </div>
        </section>
      <% } %>

      <!-- Grid list -->
      <section class="pb-5">
        <div class="row g-3">
          <% (posts || []).forEach(p => { %>
            <div class="col-12 col-md-6 col-xl-4">
              <article class="card h-100 border rounded-4 overflow-hidden shadow-sm">
                <% if (p.imageUrl) { %>
                  <div class="ratio ratio-16x9">
                    <img src="<%= p.imageUrl %>" class="w-100 h-100 object-fit-cover" alt="<%= p.title %>">
                  </div>
                <% } %>

                <div class="card-body">
                  <!-- BADGES: Urgent = แดงจาก category เท่านั้น -->
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <% const isCatUrgent = (p.category === 'urgent'); %>
                    <% if (p.isPinned) { %><span class="badge text-bg-warning">Pinned</span><% } %>
                    <% if (isCatUrgent) { %>
                      <span class="badge text-bg-danger">Urgent</span>
                    <% } %>
                    <% if (p.category && p.category !== 'urgent') { %>
                      <span class="badge text-bg-secondary text-capitalize"><%= p.category %></span>
                    <% } %>
                  </div>

                  <h5 class="mb-1 text-truncate"><%= p.title %></h5>
                  <p class="text-muted mb-2"><%= p.excerpt || '' %></p>

                  <div class="small text-muted mb-3">
                    <i class="bi bi-person-circle me-1"></i>
                    <%= p.author || '—' %>
                      <span class="mx-2">·</span>
                      <i class="bi bi-clock me-1"></i>
                      <time datetime="<%= isoDateTime(p.publishedAt) %>" data-order="<%= isoDateTime(p.publishedAt) %>">
                        <%= fmtDateTimeGB(p.publishedAt) %>
                      </time>
                  
                  </div>

                  <div class="d-flex justify-content-between align-items-center">
                    <a href="/public-announcement/<%= p._id %>" class="btn btn-sm btn-outline-primary">Read more</a>
                    <% if (isAdmin) { %>
                      <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="<%= p._id %>">
                        <i class="bi bi-trash"></i>
                      </button>
                    <% } %>
                  </div>
                </div>
              </article>
            </div>
          <% }) %>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- Offcanvas: New Post -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="newPostCanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">New Announcement</h5>
    <button class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <form id="newPostForm">
      <div class="mb-2">
        <label class="form-label">Title</label>
        <input class="form-control" name="title" required/>
      </div>

      <div class="mb-2">
        <label class="form-label">Category</label>
        <select class="form-select" name="category">
          <option value="general">General</option>
          <option value="policy">Policy</option>
          <option value="urgent">Urgent</option>
        </select>
      </div>

      <div class="mb-2">
        <label class="form-label">Image URL (optional)</label>
        <input class="form-control" name="imageUrl" placeholder="https://..."/>
      </div>

      <div class="mb-2">
        <label class="form-label">Excerpt</label>
        <textarea class="form-control" rows="2" name="excerpt"></textarea>
      </div>

      <div class="mb-2">
        <label class="form-label">Content (HTML allowed)</label>
        <textarea class="form-control" rows="6" name="content"></textarea>
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="isPinned" name="isPinned" value="true">
        <label class="form-check-label" for="isPinned">
          <i class="bi bi-pin-angle me-1"></i> Pin this announcement to top
        </label>
      </div>

      <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>ยืนยันการลบ
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        ต้องการลบประกาศนี้หรือไม่?
        <div class="mt-2 small text-muted" id="deleteModalTitle"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ยกเลิก</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">ลบ</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ===== CREATE =====
  const newForm = document.getElementById('newPostForm');
  if (newForm) {
    newForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(newForm);
      const payload = Object.fromEntries(fd.entries());

      // ปักหมุด
      payload.isPinned = fd.get('isPinned') === 'true';
      // ทำให้ isUrgent สอดคล้องกับ category (เพื่อเข้ากันได้กับ backend)
      payload.isUrgent = (payload.category === 'urgent');

      const res = await fetch('/api/announcements', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const json = await res.json().catch(() => ({}));
      if (!res.ok || !json.ok) return alert(json.message || 'ไม่สามารถบันทึกได้');

      const off = document.getElementById('newPostCanvas');
      (bootstrap.Offcanvas.getInstance(off) || new bootstrap.Offcanvas(off)).hide();
      location.href = `/public-announcement/${json.data._id}`;
    });
  }

  // ===== DELETE with Bootstrap Modal =====
  const modalEl = document.getElementById('deleteModal');
  const deleteModal = new bootstrap.Modal(modalEl);
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  const deleteModalTitle = document.getElementById('deleteModalTitle');

  let deleteId = null;

  // เปิด modal เมื่อคลิกปุ่มลบ
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action="delete"]');
    if (!btn) return;

    deleteId = btn.dataset.id || null;

    // ดึง title จากการ์ดใกล้ ๆ เพื่อแสดงใน modal (ถ้าเจอ)
    let title = '';
    const card = btn.closest('.card');
    if (card) {
      const h = card.querySelector('h3, h5');
      if (h) title = h.textContent.trim();
    }
    deleteModalTitle.textContent = title ? `“${title}”` : '';

    deleteModal.show();
  });

  // กดยืนยันลบใน modal
  confirmDeleteBtn.addEventListener('click', async () => {
    if (!deleteId) return;
    const original = confirmDeleteBtn.innerHTML;
    confirmDeleteBtn.disabled = true;
    confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> กำลังลบ...';

    try {
      const res = await fetch(`/api/announcements/${deleteId}`, { method:'DELETE' });
      const json = await res.json().catch(()=>({}));
      if (!res.ok || !json.ok) throw new Error(json.message || 'ลบไม่สำเร็จ');

      deleteModal.hide();
      location.reload();
    } catch (err) {
      alert(err.message || 'เกิดข้อผิดพลาดในการเชื่อมต่อ');
      confirmDeleteBtn.disabled = false;
      confirmDeleteBtn.innerHTML = original;
    }
  });
</script>
</body>
</html>
