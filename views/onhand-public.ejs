<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>On Shelf</title>

  <!-- Bootstrap / Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"/>
  <link rel="icon" href="/images/storage.png" sizes="32x32"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet"/>

  <link rel="stylesheet" href="/css/styles.css"/>
</head>
<body>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">

      <h2 class="text-center p-4">
        Stock on-shelf (Public View)
        <img src="/images/procurement.png" alt="logo" class="img-fluid" style="max-width: 40px; vertical-align: middle"/>
      </h2>

      <div class="container-fluid">
        <div class="p-2">
          <div class="row">
            <!-- Machine Type filter -->
            <div class="col-lg-6 col-12 mx-auto mb-2">
              <select class="select2" id="MachineType" multiple tabindex="0" name="machineTypes-ui-only">
                <option value=""></option>
                <% (machineTypeOptions || []).forEach(t => { %>
                  <option value="<%= t %>" <%= (Array.isArray(machineTypesSelected) && machineTypesSelected.includes(t)) ? 'selected' : '' %>>
                    <%= t %>
                  </option>
                <% }) %>
              </select>
            </div>
            

            <!-- Search -->
            <div class="col-lg-6 col-12 mx-auto mb-2">
              <form method="get" action="/public-onhand" class="d-flex">
                <input type="text" name="search" class="form-control me-2" value="<%= search %>" placeholder="กรอก SKU หรือ Description"/>
                <button type="submit" class="btn btn-success w-sm-auto">ค้นหา</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Cards -->
      <div class="row">
        <% if (products.length > 0) { %>
          <% products.forEach(product => { %>
            <div class="col-md-4 product-card mb-4">
              <div class="card h-100 card-hover">
                <a>
                  <img class="card-img-top img-fluid fixed-size"
                       src="https://res.cloudinary.com/dzuw4hsd7/image/upload/f_auto,q_auto/<%= product.image %>?v=<%= Date.now() %>"
                       alt="Product Image"
                       loading="lazy"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                  <div style="display:none; justify-content:center; align-items:center; height:160px;" class="text-muted">
                    <i class="fas fa-image fa-3x"></i>
                  </div>
                </a>
                <div class="card-body">
                  <h5 class="card-title text-center pb-3"><%= product.sku %></h5>
                  <p class="card-text">Description: <%= product.description %></p>
                  <p class="card-text">
                    Cost:
                    <%= new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(product.cost) %>
                  </p>
                  <h4 class="card-text text-end <%= product.quantity <= 0 ? 'text-danger' : 'text-dark' %>">
                    Quantity: <%= product.quantity %>
                  </h4>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="alert alert-warning text-center" role="alert">ไม่พบข้อมูลที่ตรงกับคำค้นหา</div>
        <% } %>
      </div>

      <!-- Pagination -->
      <div class="overflow-auto">
        <%
          const pageWindow = 2;
          let startPage = Math.max(1, current - pageWindow);
          let endPage = Math.min(pages, current + pageWindow);
          if (current <= pageWindow) endPage = Math.min(pages, startPage + 4);
          if (current + pageWindow > pages) startPage = Math.max(1, pages - 4);

          const mtQuery = (Array.isArray(machineTypesSelected) && machineTypesSelected.length)
            ? '&' + machineTypesSelected.map(mt => 'machineTypes=' + encodeURIComponent(mt)).join('&')
            : '';
          const searchQuery = search ? '&search=' + encodeURIComponent(search) : '';
        %>

        <nav aria-label="Page navigation" class="mt-4">
          <ul class="pagination justify-content-center flex-wrap">
            <li class="page-item <%= current <= 1 ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= current - 1 %><%= searchQuery %><%= mtQuery %>">Previous</a>
            </li>

            <% if (startPage > 1) { %>
              <li class="page-item"><a class="page-link" href="?page=1<%= searchQuery %><%= mtQuery %>">1</a></li>
              <% if (startPage > 2) { %>
                <li class="page-item disabled"><span class="page-link">...</span></li>
              <% } %>
            <% } %>

            <% for (let i = startPage; i <= endPage; i++) { %>
              <li class="page-item <%= current === i ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %><%= searchQuery %><%= mtQuery %>"><%= i %></a>
              </li>
            <% } %>

            <% if (endPage < pages) { %>
              <% if (endPage < pages - 1) { %>
                <li class="page-item disabled"><span class="page-link">...</span></li>
              <% } %>
              <li class="page-item">
                <a class="page-link" href="?page=<%= pages %><%= searchQuery %><%= mtQuery %>"><%= pages %></a>
              </li>
            <% } %>

            <li class="page-item <%= current >= pages ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= current + 1 %><%= searchQuery %><%= mtQuery %>">Next</a>
            </li>
          </ul>
        </nav>
        <p class="text-center">หน้าที่ <%= current %> จากทั้งหมด <%= pages %> หน้า</p>
      </div>

    </div>
  </div>
</div>

<!-- autofocus + select text on reload -->
<script>
  window.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput && searchInput.value) { searchInput.focus(); searchInput.select(); }
  });
</script>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(function () {
  // ✅ ฟอร์มที่จะส่ง
  const $form = $('form[action="/public-onhand"]');

  // ✅ init select2
  const $mt = $('#MachineType').select2({
    theme: 'bootstrap-5',
    placeholder: 'กรุณาเลือก Machine Type',
    allowClear: true,
    width: '100%',
    minimumResultsForSearch: 0
  });

  // ---- กัน “เคลียร์แล้วเผลอเลือก Clover” (Safari/บางเบราว์เซอร์) ----
  let isClearing = false;
  let clearedAt = 0;      // timestamp เมื่อเคลียร์ล่าสุด
  let submitTimer = null;

  function doClear() {
    isClearing = true;
    clearedAt = Date.now();

    // ล้างค่า + แจ้ง change
    $mt.val(null).trigger('change');

    // ปิด dropdown ทันที
    $mt.select2('close');

    // โฟกัสไปช่องค้นหาเพื่อกัน key event ตกค้าง
    const $search = $('input[name="search"]');
    if ($search.length) $search.focus();

    // หน่วงก่อน submit เล็กน้อย ให้ event เงียบลง
    clearTimeout(submitTimer);
    submitTimer = setTimeout(() => { $form.trigger('submit'); }, 160);

    // ปลดธงหลังจบเฟรม
    setTimeout(() => { isClearing = false; }, 0);
  }

  // 1) ดักปุ่ม clear แบบ "capture" ให้ชนะ Select2 เสมอ
  document.addEventListener('mousedown', function (e) {
    const clearBtn = e.target.closest('.select2-selection__clear');
    if (!clearBtn) return;
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    doClear();
  }, true); // capture = true

  document.addEventListener('click', function (e) {
    const clearBtn = e.target.closest('.select2-selection__clear');
    if (!clearBtn) return;
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    // doClear เรียกใน mousedown แล้ว
  }, true);

  // 2) กันคลิกที่ตัวกล่อง select2 ภายใน 250ms หลังเคลียร์ (กันเปิด dropdown)
  document.addEventListener('mousedown', function (e) {
    const sel = e.target.closest('.select2-selection');
    if (!sel) return;
    if (Date.now() - clearedAt < 250) {
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    }
  }, true);

  // 3) หากระหว่างเคลียร์มีอีเวนต์เปิด/เลือกเด้งมา ให้ยกเลิก
  $mt.on('select2:opening select2:open select2:select select2:unselect', function (ev) {
    if (isClearing || (Date.now() - clearedAt < 250)) {
      ev.preventDefault();
      $mt.select2('close');
    }
  });

  // 4) ปิด dropdown อีกรอบเมื่อ select2 แจ้ง clear
  $mt.on('select2:clear', function () { $mt.select2('close'); });

  // 5) change ปกติ (เลือก/ยกเลิกเอง) ให้ debounce submit
  $mt.on('change', function () {
    if (isClearing) return; // เคลียร์จะ submit ใน doClear()
    clearTimeout(submitTimer);
    submitTimer = setTimeout(() => $form.trigger('submit'), 120);
  });

  // ✅ ก่อน submit แนบ hidden inputs ของ machineTypes
  $form.on('submit', function () {
    $(this).find('input[name="machineTypes"]').remove();
    const selected = $mt.val() || [];
    selected.forEach(v => {
      $('<input>', { type: 'hidden', name: 'machineTypes', value: v }).appendTo($form);
    });
  });
});
</script>

</body>
</html>
