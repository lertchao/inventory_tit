<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Work Detail (Read-only)</title>

  <!-- Same stack as your existing page -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="icon" href="images/storage.png" sizes="32x32" />

  <style>
    .table-sm td, .table-sm th { vertical-align: middle; }
    .section-title { font-weight: 700; }
    .badge-status { min-width: 76px; }
  </style>
</head>

<body>
  <div class="container mt-5">

    <!-- Work Info Card -->
    <div class="card border rounded-4 shadow-sm mt-4" style="border-color: #dee2e6 !important; background-color: #fff;">
        <div class="card-body py-4 px-4">
          <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
            <h4 class="mb-0 fw-bold text-dark">
              <i class="bi bi-card-list me-2 text-secondary"></i>
              Request ID:
              <span class="text-secondary"><%= requestId %></span>
            </h4>
            <span class="badge px-3 py-2 fs-6
              <%= transactions[0]?.workStatus === 'Cancel'
                ? 'bg-danger'
                : (transactions[0]?.workStatus === 'Finish'
                  ? 'bg-success'
                  : 'bg-secondary') %>">
              <%= transactions[0]?.workStatus || '-' %>
            </span>
          </div>
      
          <div class="row g-4 mb-2">
            <div class="col-md-6 col-lg-3">
              <div class="text-muted small">Store</div>
              <div class="fw-semibold text-dark">
                <%= (transactions[0].storeId != null)
                      ? String(transactions[0].storeId).padStart(3, '0')
                      : '-' %> – <%= transactions[0].storename || 'N/A' %>
              </div>
            </div>
      
            <div class="col-md-6 col-lg-3">
              <div class="text-muted small">Name</div>
              <div class="fw-semibold text-dark"><%= transactions[0]?.requesterName || '-' %></div>
            </div>
      
          </div>
      
          <hr class="my-3" style="border-top: 1px solid #797878;" />
      
          <div class="text-end text-muted small">
            <i class="bi bi-clock me-1"></i>
            Created At: <%= transactions[0]?.createdAtFormatted || '-' %> &nbsp;&nbsp;
            <i class="bi bi-arrow-repeat me-1"></i>
            Last Updated: <%= transactions[0]?.updatedAtFormatted || '-' %>
          </div>
        </div>
      </div>
      
  

      <%
      // รวมข้อมูลสินค้าเพื่อทำ summary ต่อ SKU
      const summary = {};
      (transactions || []).forEach(tx => {
        (tx.products || []).forEach(p => {
          const sku  = p.sku;
          const desc = p.description || '';
          const qty  = Number(p.quantity) || 0;
          const cost = Number(p.cost) || 0;
    
          // ถ้า transactionType เป็น IN ให้นับกลับ (+) ถ้า OUT ให้เป็น (-)
          const signedQty = (tx.transactionType === 'IN') ? qty : -qty;
    
          if (!summary[sku]) {
            summary[sku] = { description: desc, net: 0, cost };
          }
          summary[sku].net += signedQty;
          summary[sku].cost = cost; // อัปเดตราคาล่าสุด
        });
      });
    
      const summaryKeys = Object.keys(summary);
    
      // ✅ รวมต้นทุนทั้งหมดของรายการเบิกออก
      // กรณี net < 0 (เบิกออก) → คำนวณเป็นจำนวนบวก
      let totalCost = 0;
    %>
    
    <h3 class="mt-4">Summary (รายการเบิก)</h3>
    <div class="table-responsive mt-3">
      <table class="table table-bordered mt-3" id="summaryTable">
        <thead class="table-dark">
          <tr>
            <th class="text-center col-1 align-middle">#</th>
            <th class="text-center col-2 align-middle">SKU</th>
            <th class="text-center col-4 align-middle">Description</th>
            <th class="text-center col-2 align-middle">Net Quantity</th>
            <th class="text-center col-1 align-middle">Cost/pcs</th>
            <th class="text-center col-2 align-middle">Amount Cost</th>
          </tr>
        </thead>
        <tbody>
          <% if (summaryKeys.length) { %>
            <% summaryKeys.forEach((sku, idx) => { 
                 const net   = Number(summary[sku].net || 0);
                 const cost  = Number(summary[sku].cost || 0);
                 // คิดเฉพาะ OUT เป็นค่าใช้จ่าย (net ติดลบ)
                 const amountCost = net < 0 ? (-net) * cost : 0;
                 totalCost += amountCost;
            %>
              <tr>
                <td class="text-center align-middle"><%= idx + 1 %></td>
                <td class="text-center align-middle"><%= sku %></td>
                <td class="align-middle"><%= summary[sku].description %></td>
                <td class="text-center align-middle"><%= net %></td>
                <td class="text-center align-middle">
                  <%= cost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </td>
                <td class="text-center align-middle fw-semibold">
                  <%= amountCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td class="text-center" colspan="6">No summary available.</td></tr>
          <% } %>
        </tbody>
    
        <% if (summaryKeys.length) { %>
            <tfoot class="table-warning">
                <tr>
                    <th colspan="5" class="text-end">Total Cost</th>
                    <th class="text-center fw-bold bg-warning-subtle text-dark">
                        <%= totalCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                    </th>
                </tr>
            </tfoot>
        <% } %>
      </table>
    </div>
    

    

  </div>

  <!-- Only Bootstrap JS (no update scripts) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
